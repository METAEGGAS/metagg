<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Record</title>
<style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#3E2723 0%,#4E342E 100%);min-height:100vh;direction:rtl}#topBar{background:#2C1810;padding:15px 20px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 12px rgba(0,0,0,0.3);position:relative}#backBtn{background:none;border:none;color:#D7CCC8;font-size:28px;cursor:pointer;padding:5px;transition:color 0.3s;position:absolute;left:20px}#backBtn:hover{color:#fff}#pageTitle{color:#D7CCC8;font-size:20px;font-weight:600;position:absolute;left:50%;transform:translateX(-50%)}#langBtn{background:#5D4037;color:#D7CCC8;border:none;padding:8px 16px;border-radius:20px;cursor:pointer;font-weight:600;font-size:13px;transition:all 0.3s;position:absolute;right:20px}#langBtn:hover{background:#6D4C41;color:#fff}#notificationsList{padding:20px;max-width:900px;margin:0 auto}.notification{background:linear-gradient(145deg,#4E342E,#3E2723);border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 6px 16px rgba(0,0,0,0.4);border-left:4px solid #8D6E63;transition:transform 0.3s}.notification:hover{transform:translateY(-3px)}.notification .header{display:flex;align-items:center;gap:15px;margin-bottom:15px}.notification .icon{width:50px;height:50px;object-fit:contain;background:#5D4037;padding:10px;border-radius:50%;box-shadow:0 4px 8px rgba(0,0,0,0.3)}.notification .info{flex:1}.notification .userName{color:#D7CCC8;font-size:18px;font-weight:700;margin-bottom:5px}.notification .status{display:inline-block;background:#4CAF50;color:#fff;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;box-shadow:0 2px 6px rgba(76,175,80,0.4)}.notification .message{color:#BCAAA4;line-height:1.8;margin-bottom:12px;font-size:15px}.notification .amount{color:#FFD54F;font-size:22px;font-weight:900;font-family:'Arial Black',sans-serif;margin:10px 0;text-shadow:0 2px 4px rgba(0,0,0,0.3)}.notification .footer{display:flex;justify-content:space-between;color:#8D6E63;font-size:12px;margin-top:15px;font-weight:600}.empty{text-align:center;color:#8D6E63;font-size:16px;padding:40px;margin-top:20px}.loading{text-align:center;color:#D7CCC8;font-size:16px;padding:40px}</style>
</head>
<body>
<div id="topBar"><button id="backBtn" onclick="history.back()">←</button><span id="pageTitle">Record</span><button id="langBtn" onclick="toggleLang()">EN</button></div>
<div id="notificationsList"><div class="loading">جاري التحميل...</div></div>
<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import{getFirestore,collection,query,where,onSnapshot,addDoc,serverTimestamp,orderBy,getDocs}from"https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
import{getAuth,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
const app=initializeApp({apiKey:"AIzaSyA-MK1RYmvpYJrTOBAQcxDqxhp-z_FOb1o",authDomain:"mzjsjjshs.firebaseapp.com",projectId:"mzjsjjshs",storageBucket:"mzjsjjshs.firebasestorage.app",messagingSenderId:"944370558426",appId:"1:944370558426:web:70d4ee772c487f48b58ce3",measurementId:"G-CWJWKWBBST"});
const db=getFirestore(app),auth=getAuth(app),processedTransactions=new Set();
let currentLang='ar',currentUserId=null,currentUserEmail=null;
window.toggleLang=()=>{currentLang=currentLang==='ar'?'en':'ar';document.getElementById('langBtn').textContent=currentLang==='ar'?'EN':'AR';renderNotifications()};
const toEnglishNum=str=>String(str).replace(/[٠-٩]/g,d=>d.charCodeAt(0)-1632).replace(/[\u0660-\u0669]/g,d=>d.charCodeAt(0)-1632);
const texts={ar:{greeting:"مرحباً عزيزي",processed:"تمت معالجة طلب الإيداع الخاص بك بنجاح",amount:"المبلغ المودع:",enjoy:"نتمنى لك تجربة ممتعة مع خدماتنا",completed:"مكتمل",requestNum:"رقم الطلب:",date:"التاريخ:",empty:"لا توجد إشعارات في الوقت الحالي",loading:"جاري التحميل...",pleaseLogin:"يرجى تسجيل الدخول أولاً"},en:{greeting:"Dear",processed:"Your deposit request has been successfully processed",amount:"Deposited Amount:",enjoy:"Enjoy our premium services",completed:"Completed",requestNum:"Request #",date:"Date:",empty:"No notifications available",loading:"Loading...",pleaseLogin:"Please login first"}};
let notificationsData=[];
const notificationsRef=collection(db,"notifications"),transactionsRef=collection(db,"transactions");
onAuthStateChanged(auth,user=>{if(user){currentUserId=user.uid;currentUserEmail=user.email;loadProcessedTransactions();listenToTransactions();listenToNotifications()}else{document.getElementById("notificationsList").innerHTML=`<div class="empty">${texts[currentLang].pleaseLogin}</div>`}});
async function loadProcessedTransactions(){if(!currentUserId)return;const q=query(notificationsRef,where("userId","==",currentUserId));const snapshot=await getDocs(q);snapshot.forEach(doc=>{const data=doc.data();if(data.transactionId)processedTransactions.add(data.transactionId)})}
function listenToTransactions(){if(!currentUserId)return;const queries=[query(transactionsRef,where("userId","==",currentUserId),where("status","==","approved"))];if(currentUserEmail)queries.push(query(transactionsRef,where("userEmail","==",currentUserEmail),where("status","==","approved")));queries.forEach(q=>{onSnapshot(q,snapshot=>{snapshot.docChanges().forEach(change=>{if(change.type==="added"||change.type==="modified"){const data=change.doc.data(),docId=change.doc.id;if(data.status==="approved"&&!processedTransactions.has(docId)&&(data.userId===currentUserId||data.userEmail===currentUserEmail)){processedTransactions.add(docId);addDoc(notificationsRef,{userId:currentUserId,userEmail:currentUserEmail,userName:data.userName||"المستخدم",amount:data.amount||0,status:"مكتمل",timestamp:serverTimestamp(),transactionId:docId}).catch(err=>console.error("Error:",err))}}})})})}
function listenToNotifications(){if(!currentUserId)return;const notifQuery=query(notificationsRef,where("userId","==",currentUserId),orderBy("timestamp","desc"));onSnapshot(notifQuery,snapshot=>{const container=document.getElementById("notificationsList");if(snapshot.empty){container.innerHTML=`<div class="empty">${texts[currentLang].empty}</div>`;return}notificationsData=[];snapshot.forEach(doc=>{notificationsData.push({id:doc.id,...doc.data()})});renderNotifications()})}
function renderNotifications(){const container=document.getElementById("notificationsList");if(notificationsData.length===0){container.innerHTML=`<div class="loading">${texts[currentLang].loading}</div>`;return}container.innerHTML="";notificationsData.forEach(data=>{const notifDiv=document.createElement("div");notifDiv.className="notification";const timestamp=data.timestamp?data.timestamp.toDate():new Date(),dateStr=toEnglishNum(timestamp.toLocaleDateString(currentLang==='ar'?'ar-EG':'en-US')),timeStr=toEnglishNum(timestamp.toLocaleTimeString(currentLang==='ar'?'ar-EG':'en-US',{hour:'2-digit',minute:'2-digit'})),reqNum=toEnglishNum(data.transactionId?data.transactionId.substring(0,8).toUpperCase():Math.random().toString(36).substring(2,10).toUpperCase()),userName=data.userName||"المستخدم",amount=toEnglishNum(data.amount||0),t=texts[currentLang];notifDiv.innerHTML=`<div class="header"><img src="https://cdn-icons-png.flaticon.com/128/19033/19033034.png" alt="deposit" class="icon"><div class="info"><div class="userName">${t.greeting} ${userName}</div><span class="status">${t.completed}</span></div></div><div class="message">${t.processed}</div><div class="amount">${amount} USD</div><div class="message">${t.enjoy}</div><div class="footer"><span class="reqNum">${t.requestNum} ${reqNum}</span><span class="date">${t.date} ${dateStr} - ${timeStr}</span></div>`;container.appendChild(notifDiv)})}
</script>
</body>
</html>

